{"name":"Heiti potturinn","description":"Stjórnar þremur vatnslokum.\n - Heitavatnsloki\n - Kaldavatnsloki\n - Tæma loki","code":"var using = [\"TextPinCtrl\",\"HotTubTempCtrl\", \"SwitchCtrl\", \"SvgCtrl\",\"SliderCtrl\",\"TextCtrl\"];\r\n\r\nvar device, switchDrain, hotTub;\r\nvar pinFill, pinDrain;\r\nvar switchFill, switchDrain;\r\n\r\nvar setupAppPins = function setupAppPins(device, xBase, yBase, statusResponse){\r\n\r\nvar bak = new SvgCtrl('bakgrunnur', 0,30, 200,200);\r\n    //pinFill = device.get(5);\r\n    //pinDrain = device.get(4);\r\n    \r\n    \r\n    bak.addText(60,43, \"Fylla\");\r\n    bak.addText(38,152, \"Tæma\");\r\n    /*var timi = new TextCtrl(145,240, 'Fylla tekur 1 klst og 54 min');*/\r\n    \r\n    var pinCount = device.pins.length;\r\n    \r\n    hotTub = new HotTubTempCtrl('hot-tub', xBase, yBase, 330,185, statusResponse);\r\n    \r\n    pinFill = new Pin(5, 0, device.savedDeviceID, 100, device.savedDeviceID);\r\n    pinDrain = new Pin(4, 0, device.savedDeviceID, 100, device.savedDeviceID);\r\n    \r\n    \r\n    //fillPin\r\n    var slider = new SliderCtrl(xBase + 110, 18, pinFill);\r\n    var fillNum = new TextPinCtrl(310,15, pinFill);\r\n    fillNum.scale(1.5);\r\n    slider.getSlider().css('width', '180px');\r\n    switchFill = new SwitchCtrl(xBase + 10, 0, pinFill, 100);\r\n    switchFill.scale(0.7);\r\n    \r\n    //drainPin\r\n    \r\n    // normal                      01:54        06:00\r\n    //hotTub.setFlowTimeInMinutes((54 + (60*1)), 60*6 );\r\n    // when hottub is leaking      02:30         05:30\r\n    switchDrain = new SwitchCtrl(xBase + 10, 110, pinDrain);\r\n    switchDrain.scale(0.7);\r\n    switchDrain.rotate(180);\r\n    \r\n    pinDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n    pinFill.setValue(hotTub.isFilling()? 100 : 0);\r\n    \r\n    pinFill.registerClicks(onClickCAllbackFill);\r\n    pinDrain.registerClicks(onClickCAllbackDrain);\r\n    \r\n};\r\n\r\n\r\n\r\nfunction updateView(device, pinValues ) {\r\n    console.log(\"todo: get status and update view\");\r\n    /*var drainPin = pinDrain.number, fillPin = pinFill.number;\r\n      var pinObj, val;\r\n      console.log('updateView');console.log(pinValues);\r\n        for(var i = 0; i<pinValues.length;i++){\r\n            pinObj = device.get(pinValues[i].pin);\r\n            val    = pinValues[i].val;\r\n            pinObj.setValue(val);\r\n        }\r\n        */\r\n}\r\n\r\nfunction fetchDeviceStatus() {\r\n\r\n    \r\n    var posting = $.get(getServer()+'/devices/status/'+device.savedDeviceID);\r\n    \r\n    \r\n    \r\n    posting.done(function(data){\r\n        hotTub.setStatus(data);\r\n        \r\n        //switchDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n        pinDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n        pinFill.setValue(hotTub.isFilling()? 100 : 0);\r\n        //switchFill.setValue(hotTub.isFilling()? 100 : 0);\r\n       \r\n        \r\n        switchDrain.active(true);\r\n        switchFill.active(true);\r\n    })\r\n    .fail(function(data){\r\n        console.log(\"failed getting hot tub status status\");\r\n        if (errorCallback!==undefined){\r\n            console.log(data);\r\n            errorCallback(data);\r\n        }\r\n    });\r\n}\r\n\r\nfunction drawControls(xOff, yOff){\r\n    var x = xOff+25,\r\n        y = yOff-20;\r\n    \r\n    //var posting = $.get(getServer()+'/devices/pins/'+this.savedDeviceID);\r\n    console.log(`device.ID:${device.savedDeviceID}`);\r\n    var posting = $.get(getServer()+'/devices/status/'+device.savedDeviceID);\r\n    \r\n    posting.done(function(data){\r\n         setupAppPins(device, xOff, yOff, data);\r\n    })\r\n    .fail(function(data){\r\n        console.log(\"failed getting hot tub status status\");\r\n            console.log(data);\r\n    });\r\n    \r\n    /*device.fetchAllPins(\r\n        function(){ setupAppPins(device, xOff, yOff); } , \r\n         setupFailed\r\n    );*/\r\n}\r\n\r\nfunction newDataToView(data){\r\n    var pinNumber, newValue;\r\n    console.log(\"newDataToView\");console.log(data);\r\n    for(var i = 0;i<data.pins.length;i++){\r\n        pinNumber = data.pins[i].pin;\r\n        if (pinNumber === pinDrain.number  || pinNumber === pinFill.number ) {   \r\n            newValue = data.pins[i].val;\r\n            device.get(pinNumber).setValue(newValue);\r\n        }\r\n    }\r\n    //etWaterLevel(device);\r\n}\r\n\r\nfunction onClickCAllbackDrain(obj){\r\n    var pin = obj.pinObject;\r\n    pin.active(false);\r\n    var sendObj = {\r\n        cmd:pin.value == 0? \"drain\" : \"stop\"\r\n    };\r\n    //pin.setValue(pin.value === 0? 100:0);\r\n    //sen\r\n    var url = getServer()+'/devices/custom/'+ pin.savedDeviceID;\r\n    var posting = $.post( url, sendObj);\r\n    console.log(`${url}\\n${JSON.stringify(sendObj, null, 4)}`);\r\n    posting.done(function(data){\r\n       fetchDeviceStatus();\r\n    });\r\n}\r\n\r\nfunction onClickCAllbackFill(obj){\r\n    var pin = obj.pinObject;\r\n    pin.active(false);\r\n    \r\n    var sendObj = {\r\n         cmd:pin.value == 0? \"fill\" : \"stop\",\r\n         temperature:Number(hotTub.getDesiredTemperatureInput().val())\r\n    };\r\n    //pin.setValue(pin.value === 0? 100:0);\r\n    //sendObj[pin.number] =  obj.pinValue;\r\n    var url = getServer()+'/devices/custom/'+ pin.savedDeviceID;\r\n    hotTub.stop();\r\n    var posting = $.post( url, sendObj);\r\n    console.log(`${url}\\n${JSON.stringify(sendObj, null, 4)}`);\r\n    posting.done(function(data){\r\n        fetchDeviceStatus();\r\n    });\r\n}\r\n\r\n\r\n\r\nfunction displayError(title, message){\r\n    showModal(title, \r\n            '\\n\\n<p class=\"error-response-text\">Error :<br>' + \r\n            message + '</p>');\r\n}\r\n\r\nvar setupFailed = function (data){\r\n    console.error('Næ ekki sambandi við stýritæki pottsins');\r\n    console.error(data);\r\n    displayError(\"Tengivilla\", \"Næ ekki sambandi við stýringu pottsins\");\r\n};\r\n\r\n\r\n$(function () {\r\n    device = new Device('61052c38bc1fdd0526aedf31', 100);\r\n    drawControls(10, 50);\r\n    //$('body').css(\"background\",\"rgb(51, 22, 51)\");\r\n});","helpurl":"http://www.guttih.com/projects/hottub","active":true}