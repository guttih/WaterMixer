{"name":"Heiti potturinn","description":"Stjórnar þremur vatnslokum.\r\n - Heitavatnsloki\r\n - Kaldavatnsloki\r\n - Tæma loki","code":"var using = [\"TextPinCtrl\",\"HotTubTempCtrl\", \"SwitchCtrl\", \"SvgCtrl\",\"SliderCtrl\",\"TextCtrl\"];\r\n\r\nvar device, switchDrain, hotTub;\r\nvar pinFill, pinDrain;\r\nvar switchFill, switchDrain;\r\n\r\nvar setupAppPins = function setupAppPins(device, xBase, yBase, statusResponse){\r\n\r\nvar bak = new SvgCtrl('bakgrunnur', 0,30, 200,200);\r\n    //pinFill = device.get(5);\r\n\t//pinDrain = device.get(4);\r\n\t\r\n\t\r\n\tbak.addText(60,43, \"Fylla\");\r\n\tbak.addText(38,152, \"Tæma\");\r\n\t/*var timi = new TextCtrl(145,240, 'Fylla tekur 1 klst og 54 min');*/\r\n\t\r\n\tvar pinCount = device.pins.length;\r\n\t\r\n\thotTub = new HotTubTempCtrl('hot-tub', xBase, yBase, 330,185, statusResponse);\r\n\t\r\n\tpinFill = new Pin(5, 0, device.savedDeviceID, 100, device.savedDeviceID);\r\n\tpinDrain = new Pin(4, 0, device.savedDeviceID, 100, device.savedDeviceID);\r\n\t\r\n\t\r\n\t//fillPin\r\n\tvar slider = new SliderCtrl(xBase + 110, 18, pinFill);\r\n\tvar fillNum = new TextPinCtrl(310,15, pinFill);\r\n    fillNum.scale(1.5);\r\n\tslider.getSlider().css('width', '180px');\r\n\tswitchFill = new SwitchCtrl(xBase + 10, 0, pinFill, 100);\r\n    switchFill.scale(0.7);\r\n\t\r\n\t//drainPin\r\n\t\r\n\t// normal                      01:54        06:00\r\n\t//hotTub.setFlowTimeInMinutes((54 + (60*1)), 60*6 );\r\n\t// when hottub is leaking      02:30         05:30\r\n\thotTub.setFlowTimeInMinutes(60*1, (60*5)+30 );\r\n    console.log(hotTub);\r\n\tswitchDrain = new SwitchCtrl(xBase + 10, 110, pinDrain);\r\n    switchDrain.scale(0.7);\r\n    switchDrain.rotate(180);\r\n    \r\n    pinDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n    pinFill.setValue(hotTub.isFilling()? 100 : 0);\r\n    \r\n\tpinFill.registerClicks(onClickCAllbackFill);\r\n\tpinDrain.registerClicks(onClickCAllbackDrain);\r\n\t\r\n\t//updateView(device, device.pinsToSendArray());\r\n\t\r\n    //getWaterLevel(device);\r\n    \r\n    var t0 = new TextCtrl(360,0, 'Á meðan er verið að renna í pottinn á þá er þrýstingur:');\r\n    var t1 = new TextCtrl(380,20, '- Þegar potturinn er tómur þá: 2.85, 2.86, 2.87 BAR SÁ LÍKA 2.80 SEINNA');\r\n    var t2 = new TextCtrl(380,58, '- Þegar potturinn er fullur þá: 2.94 to 2.97 BAR');\r\n    var t3 = new TextCtrl(380,70, '- Það hefur mikil áhrif hve mikið er opið fyrir heita lokann.  Þrýstingur eykst ef meira er opnað fyrir heita vatnið');\r\n    t0.getElement().css('color','Green');\r\n    t1.getElement().css('color','blue');\r\n    t2.getElement().css('color','red');\r\n    \r\n    \r\n\t\r\n\t\r\n};\r\n\r\n\r\n\r\nfunction updateView(device, pinValues ) {\r\n    console.log(\"todo: get status and update view\");\r\n    /*var drainPin = pinDrain.number, fillPin = pinFill.number;\r\n      var pinObj, val;\r\n      console.log('updateView');console.log(pinValues);\r\n\t\tfor(var i = 0; i<pinValues.length;i++){\r\n            pinObj = device.get(pinValues[i].pin);\r\n            val    = pinValues[i].val;\r\n            pinObj.setValue(val);\r\n\t\t}\r\n\t\t*/\r\n}\r\n\r\nfunction fetchDeviceStatus() {\r\n\r\n\t\r\n\tvar posting = $.get(getServer()+'/devices/status/'+device.savedDeviceID);\r\n\t\r\n\t\r\n\t\r\n\tposting.done(function(data){\r\n\t    hotTub.setStatus(data);\r\n\t    \r\n\t    //switchDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n\t    pinDrain.setValue(hotTub.isDraining()? 100 : 0);\r\n\t    pinFill.setValue(hotTub.isFilling()? 100 : 0);\r\n\t    //switchFill.setValue(hotTub.isFilling()? 100 : 0);\r\n\t   \r\n\t    \r\n\t    switchDrain.active(true);\r\n        switchFill.active(true);\r\n\t})\r\n\t.fail(function(data){\r\n\t\tconsole.log(\"failed getting hot tub status status\");\r\n\t\tif (errorCallback!==undefined){\r\n\t\t    console.log(data);\r\n\t\t\terrorCallback(data);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction drawControls(xOff, yOff){\r\n\tvar x = xOff+25,\r\n\t\ty = yOff-20;\r\n\t\r\n\t//var posting = $.get(getServer()+'/devices/pins/'+this.savedDeviceID);\r\n\tconsole.log(\"device.ID\");\r\n\tconsole.log(device.savedDeviceID);\r\n\tvar posting = $.get(getServer()+'/devices/status/'+device.savedDeviceID);\r\n\t\r\n\tposting.done(function(data){\r\n\t     setupAppPins(device, xOff, yOff, data);\r\n\t})\r\n\t.fail(function(data){\r\n\t\tconsole.log(\"failed getting hot tub status status\");\r\n\t\t\tconsole.log(data);\r\n\t});\r\n\t\r\n    /*device.fetchAllPins(\r\n        function(){ setupAppPins(device, xOff, yOff); } , \r\n         setupFailed\r\n    );*/\r\n}\r\n\r\nfunction newDataToView(data){\r\n    var pinNumber, newValue;\r\n    console.log(\"newDataToView\");console.log(data);\r\n    for(var i = 0;i<data.pins.length;i++){\r\n        pinNumber = data.pins[i].pin;\r\n        if (pinNumber === pinDrain.number  || pinNumber === pinFill.number ) {   \r\n            newValue = data.pins[i].val;\r\n            device.get(pinNumber).setValue(newValue);\r\n        }\r\n    }\r\n    //etWaterLevel(device);\r\n}\r\n\r\nfunction onClickCAllbackDrain(obj){\r\n\tvar pin = obj.pinObject;\r\n\tpin.active(false);\r\n\tconsole.log(pin);\r\n\tvar sendObj = {\r\n\t    cmd:pin.value == 0? \"drain\" : \"stop\"\r\n\t};\r\n\t//pin.setValue(pin.value === 0? 100:0);\r\n\t//sen\r\n\tvar url = getServer()+'/devices/custom/'+ pin.savedDeviceID;\r\n\thotTub.drain();\r\n\tconsole.log('sending onClickCAllbackDrain');console.log(sendObj);\r\n\tvar posting = $.post( url, sendObj);\r\n\tposting.done(function(data){\r\n       fetchDeviceStatus();\r\n\t});\r\n}\r\n\r\nfunction onClickCAllbackFill(obj){\r\n    console.log(\"hér skal senda fill object\")\r\n\tvar pin = obj.pinObject;\r\n\tpin.active(false);\r\n\t\r\n\tvar sendObj = {\r\n\t     cmd:pin.value == 0? \"fill\" : \"stop\",\r\n\t     temperature:Number(hotTub.getDesiredTemperatureInput().val())\r\n\t};\r\n\t//pin.setValue(pin.value === 0? 100:0);\r\n\t//sendObj[pin.number] =  obj.pinValue;\r\n\tvar url = getServer()+'/devices/custom/'+ pin.savedDeviceID;\r\n\thotTub.stop();\r\n\tvar posting = $.post( url, sendObj);\r\n\tconsole.log(url);\r\n\tconsole.log(sendObj);\r\n\tconsole.log('sending onClickCAllbackFill');console.log(sendObj);\r\n\tposting.done(function(data){\r\n        fetchDeviceStatus();\r\n\t});\r\n}\r\n\r\nvar calculateWatherFlow = function calculateWatherFlow(prevObject, currentObject, index){\r\n    \r\n     var drainFlowUnits = hotTub.drainMinutes*1023, // five hours on full flow\r\n         fillFlowUnits  = hotTub.fillMinutes *1023,\r\n         drainFillProportion = hotTub.fillMinutes / hotTub.drainMinutes *-1;\r\n         \r\n        \r\n    var prevDate = new Date(prevObject.datetime);\r\n    var currDate = new Date(currentObject.datetime);\r\n    var diffMillis = (currDate.getTime()-prevDate.getTime());\r\n    var diffMinutes = (diffMillis/(1000*60));\r\n    //þarf að fá waterFlow\r\n    var pins = JSON.parse(prevObject.data).filter(item => item.pin ===4 || item.pin ===5);\r\n    var drainValue = pins.filter(item => item.pin === 4 )[0].val;\r\n    var fillValue =  pins.filter(item => item.pin === 5 )[0].val;\r\n    if (drainValue > 0) {\r\n       currentObject.flow =  drainValue * drainFillProportion;  \r\n    } else {\r\n       currentObject.flow = fillValue;\r\n    }\r\n    \r\n    currentObject.flowMinutes = diffMinutes;\r\n    currentObject.flowUnits   = diffMinutes * currentObject.flow;\r\n    \r\n    currentObject. sumFlowUnits   = prevObject.sumFlowUnits + currentObject.flowUnits;\r\n    if (currentObject. sumFlowUnits < 0) {\r\n        currentObject. sumFlowUnits = 0;\r\n        \r\n    } else if (currentObject. sumFlowUnits > fillFlowUnits) {\r\n        currentObject. sumFlowUnits = fillFlowUnits;\r\n    }\r\n    currentObject.waterLevel = Math.round((currentObject.sumFlowUnits/fillFlowUnits) * 100);\r\n    //console.log(`${index}\\t.waterLevel: ${currentObject.waterLevel}%\\t.sumFlowUnits: ${currentObject.sumFlowUnits}\\t.flowUnits: ${currentObject.flowUnits}\\tdiffMinutes: ${diffMinutes}\\tpower: ${currentObject.flow}\\t`);\r\n    \r\n}\r\n\r\n/*\r\nvar getDeviceLogs = function getDeviceLogs(deviceId){\r\n\tvar url = SERVER+'/logs/list/'+deviceId;\r\n\tvar request = $.get(url);\r\n\trequest.done(function( data ) {\r\n\t    if (data.length < 1) {\r\n\t        console.log(\"data empty:\");\r\n\t        return; \r\n\t        \r\n\t    }\r\n\t    var start = 0;\r\n\t    var drainFlowUnits = hotTub.drainMinutes*1023, // five hours on full flow\r\n\t        fillFlowUnits = hotTub.fillMinutes *1023;\r\n\t    data[start].flow      =0;\r\n\t    data[start].flowMinutes=0;\r\n\t    data[start].flowUnits  =0;\r\n\t    data[start].sumFlowUnits   =0;\r\n\t    for(var i = start+1; i<data.length;i++) {\r\n\t        data[i].date = new Date(data[i].datetime);\r\n            calculateWatherFlow(data[i-1], data[i],i);\r\n\t    }\r\n\t   \r\n\t    var lastState = data[data.length-1];\r\n\t    var now = { \r\n\t                datetime    : new Date().toString(),\r\n\t                flow        : 0,\r\n\t                flowMinutes : 0,\r\n            \t    flowUnits   : 0,\r\n            \t    sumFlowUnits: 0,\r\n            \t    waterLevel  : 0\r\n\t        \r\n\t    };\r\n\t    calculateWatherFlow(lastState, now);\r\n\t    hotTub.setWaterLevel(now.waterLevel);\r\n\t\t\r\n\t\t}).fail(function( data ) {\r\n\t\t\tif (data.status===401){\r\n\t\t\t\tshowModal(\"You need to be logged in!\", data.responseText);\r\n\t\t\t}\r\n\t\t});\r\n}\r\n*/\r\n\r\n/*\r\nvar getWaterLevelCount = 0;\r\nvar getWaterLevel = function getWaterLevel(device) {\r\n    \r\n\tgetDeviceLogs(device.savedDeviceID);\r\n\t//console.log(`${++getWaterLevelCount} | waterLevel: ${hotTub.waterLevel}% `);\r\n    setTimeout(function(){ getWaterLevel(device);  }, 10*1000);\r\n}\r\n*/\r\nfunction displayError(title, message){\r\n    showModal(title, \r\n\t\t\t'\\n\\n<p class=\"error-response-text\">Error :<br>' + \r\n\t\t\tmessage + '</p>');\r\n}\r\n\r\nvar setupFailed = function (data){\r\n\tconsole.error('Næ ekki sambandi við stýritæki pottsins');\r\n\tconsole.error(data);\r\n\tdisplayError(\"Tengivilla\", \"Næ ekki sambandi við stýringu pottsins\");\r\n};\r\n\r\n\r\n$(function () {\r\n    device = new Device('61052c38bc1fdd0526aedf31', 100);\r\n    drawControls(10, 50);\r\n    //$('body').css(\"background\",\"rgb(51, 22, 51)\");\r\n});","helpurl":"http://www.guttih.com/projects/hottub","active":true}